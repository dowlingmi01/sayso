<?php

// customer/starbar short name

$shortName = strtolower(Zend_Controller_Front::getInstance()->getRequest()->getControllerName()); 

?>
<script type="text/javascript">

    // base domain, etc per the current server environment
    
    if (!window.sayso) window.sayso = {};
    if (!window.sayso.baseDomain) {
        window.sayso.baseDomain = '<?= Registry::getConfig()->baseDomain ?>';
        window.sayso.environment = '<?= Registry::getPseudoEnvironmentName() ?>';
    }
</script>

<!-- SIMULATED customer login (popup) -->


<div id="simulate-login" style="background: white; opacity: 1; padding: 10px; margin: 15px; border: solid 2px black; width: 300px; font-family: Verdana; font-size: .8em; z-index: 10000; position: absolute; display: none;">
    <h2 style="margin: 2px;">Login <small id="simulate-login-status" style="font-size: .6em; color: green;"><?= $this->userLoggedIn ? '(logged in)' : '' ?></small></h2>
    <p style="margin: 2px;">Enter <strong>email</strong> to simulate user login</p>
    <small style="margin: 2px;">Changing email addresses (while the app is installed) simulates logging in as a different user</small>
    <form method="post" action="/client/<?= $shortName ?>/login">
        <p>
            <input type="hidden" name="uuid_type" value="<?= $this->uuidType ?>" />
            <input class="email" type="text" name="uuid" value="<?= $this->uuid ?>" style="width: 200px; font-size: 1.3em;" />&nbsp;<input class="submit" type="submit" name="simulate_submit" value="Login" />
        </p>
    </form>
</div>

<?= $this->partial($shortName . '/embed.phtml', array('shortName' => $shortName)) ?>

<script type="text/javascript">

    (function () {

        // already logged in
        if ('<?= $this->userLoggedIn ?>'.length) return;
        
        var sayso = window.sayso;

        if (!sayso.functions) {
            sayso.functions = {
                jsLoadTimer : function (){function d(){i++<=b&&(c=setTimeout(e,f))}function e(){try{if(eval(g)){c&&clearTimeout(c);try{h()}catch(a){sayso.warn(a)}}else d()}catch(b){d()}}var i=0,b=400,f=50,g="",h=null,c=null;this.setMaxCount=function(a){b=a};this.setInterval=function(a){f=a};this.setLocalReference=function(){};this.start=function(a,b){g=a;h=b;e()}},
                getCookie : function (d){for(var b=document.cookie.split(";"),a=0;a<b.length;a++){var c=b[a].split("=");if(c[0].trim()===d)return c[1].trim()}return""},
                setCookie : function (d,a,b){var c=new Date;b&&c.setDate(c.getDate()+b);a=escape(a)+(b?"; expires="+c.toUTCString():"")+"; path=/";document.cookie=d+"="+a},
                getUrlParam : function (c){if(!this.params){this.params={};for(var a,b=/\+/g,d=/([^&=]+)=?([^&]*)/g,e=window.location.search.substring(1);a=d.exec(e);)this.params[decodeURIComponent(a[1].replace(b," "))]=decodeURIComponent(a[2].replace(b," "))}return this.params[c]}
            };  
        }

        var f = sayso.functions;
        
        var jQueryInclude = document.createElement('script');         
        jQueryInclude.src = '//' + sayso.baseDomain + '/js/starbar/jquery-1.6.1.min.js';
        document.getElementsByTagName('body')[0].appendChild(jQueryInclude);
        

        var jQueryTimer = new f.jsLoadTimer();
        jQueryTimer.start('window.$SQ', function () { // note: jquery is loaded in the embed script

            // SIMULATED login form
            
            // since jquery.form is not namespaced, we transfer over the ref
            // back to jQuery/$ for it to use. This is safe in our simulated environ.
            jQuery = $ = $SQ; 
            
            var jQueryForm = document.createElement('script');         
            jQueryForm.src = '//' + sayso.baseDomain + '/js/jquery.form.min.js';
            document.getElementsByTagName('body')[0].appendChild(jQueryForm);
    
            var timer2 = new f.jsLoadTimer();
            timer2.start('typeof $.fn.ajaxForm === "function"', function () {
                
                // login popup
                setTimeout(function () {
                    $('#simulate-login').show();
                    
                    // ajax form
                    $('#simulate-login form').ajaxForm({
                        url : $(this).attr('action'),
                        type : 'post',
                        dataType : 'jsonp',
                        success : function (response) {
                            $('#simulate-login-status').text('(logged in)');
                            
                            // refresh page    
                            setTimeout(function () {
                                window.location.reload();
                            }, 1000);
                        }
                    });
                }, 1500);
            });
        });

        
        
    })();
</script>