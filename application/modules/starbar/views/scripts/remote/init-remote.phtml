<?php

switch (APPLICATION_ENV) {
    case 'development' :
        $env = 'LOCAL'; break;
    case 'sandbox' :
        $env = 'DEV'; break;
    case 'testing' :
        $env = 'TEST'; break;
    case 'staging' :
        $env = 'STAGING'; break;
    case 'production' :
    default :
        $env = 'PRODUCTION'; break;
}

$starbar = $this->starbar;
/* @var $starbar Starbar */

?>
<script type="text/javascript">
    /**
     * Purpose of this code is to represent the browser app for testing/development
     * Whatever app state is set in the KRL, should be represented here.
     * Starbar, auth key are hard coded to Hello Music
     * User is hard-coded 
     * User session is dynamic
     */
    $SQ(function () {
        if (!window.sayso) window.sayso = {};
        window.sayso.debug = true;
        window.sayso.baseDomain = '<?= BASE_DOMAIN ?>';
        window.sayso.environment = '<?= $env ?>';
        window.sayso.log = _log('log'); 
        window.sayso.warn = _log('warn');
        function _log (type) { // <-- closure here allows re-use for log() and warn()
	        return function () {
	            if (window.sayso.debug && typeof window.console !== 'undefined' && typeof window.console.log !== 'undefined') {
	                var args = Array.prototype.slice.call(arguments);
	                if (typeof console.log.apply === 'function') {
	                    args.unshift('SaySo:');
	                    window.console[type].apply(window.console, args);
	                } else {
	                    // must be IE
	                    if (typeof args[0] !== 'object') {
	                        window.console.log(args[0]);
	                    }
	                }
	            }
	        }
        };
        window.sayso.starbar = {
            id : <?= $starbar->getId() ?>, 
            shortName : '<?= $starbar->short_name ?>',
            kynetxAppId : 'a239x20', // <-- this doesn't matter in this context
            authKey : '<?= $starbar->auth_key ?>',
            user : {
                id : <?= Api_UserSession::getInstance()->getId() ?>,
                key : '<?= Api_UserSession::getInstance()->getKey() ?>'
                <? if ($this->game) { ?>
                	, gaming : <?= Zend_Json_Encoder::encode($this->game->getGamer()->export(new ObjectExporter_Array())) ?>
                <? } ?>
            },
            <? if ($this->starbar->getGame() && $this->starbar->getGame()->getLevels()) { ?>
            	game : {
                	levels : <?= Zend_Json_Encoder::encode($this->starbar->getGame()->getLevels()->export(new ObjectExporter_Array())) ?>
				},
            <? } ?>
            state : {
                visibility : 'starbar-visOpen',
            	local : {}
            },
            loaded : true
        };

        if (typeof(KOBJ) === 'undefined') {
            KOBJ = { 
                warn : function () { 
                    console.warn('Requested action has limited functionality outside of browser app.'); 
                },
                get_application : function () { 
                    return { 
                        raise_event : function () { KOBJ.warn(); }
                    } 
                }
            };
        }
    });

	$SQ('body').css('margin', 0);
</script>
<script src="http://<?= BASE_DOMAIN ?>/js/starbar/easyXDM.min.js" type="text/javascript"></script>
<script src="http://<?= BASE_DOMAIN ?>/js/starbar/sayso-shared.js" type="text/javascript"></script>
<script type="text/javascript">

	easyXDM.DomHelper.requiresJSON("http://<?= BASE_DOMAIN ?>/js/starbar/json2.min.js");

	$SQ.remoteControl = new easyXDM.Rpc({
		remote: "http://<?= BASE_DOMAIN ?>/html/communicator.html",
		local: "http://<?= BASE_DOMAIN ?>/html/communicator.html",
		swf: "http://<?= BASE_DOMAIN ?>/swf/easyxdm.swf",
	}, {
		// functions available to remote pages
		remote: {
			loadComplete: {},
			updateGame: {},
			handleTweet: {},
			alertMessage: {}
		},
		local: {}
	});

</script>
