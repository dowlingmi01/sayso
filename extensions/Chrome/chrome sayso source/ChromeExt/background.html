<html>
<script>
            /*
                a239x21 Say.So Star Bar (Production)
                a239x22 Say.So QA
                a239x18 Say.So DEV
                a239x20 Say.So LOCAL
		a239x27 Say.So STAGING
             *
             * testing: a8x15
             */

	//config
    appid = "a239x18";
    domains = [];
    var response = null;
    var init_host = null;
    var kynetx_runtime_url = "http://init.kobj.net/js/shared/kobj-static.js";
    var callback_host = null;
    var eval_host = null;
    var app_version = null;
    var full_runtime;

    //handles pagerefreshes
    chrome.extension.onRequest.addListener(message_responder);

    function message_responder(message, sender, sendResponse) {
        var response = {plantTags:false};
        if (sender.tab) {
            //from content script
            console.log(message.hostname)
            var plantTags = false;
            if (message.hostname) {
                for (i in domains) {
                    var Kdomain = new RegExp(domains[i]);
                    if (message.hostname.search(Kdomain) > -1) {
                        plantTags = true;
                        break;
                    }
                }
            }

            if (plantTags) {
                response = {
                    plantTags:true,
                    full_runtime: full_runtime,
                    config: {
                        rids: [appid],
                        endpoint: {
                            name: 'KBXch',
                            version: '0.1',
                            type: 'js'
                        }
                    }
                }

                // Check for magic dev options
                if (init_host || callback_host || eval_host) {
                    response.config["init"] = {};
                }
                if (callback_host) {
                    response.config.init["callback_host"] = callback_host;
                }
                if (eval_host) {
                    response.config.init["eval_host"] = eval_host;
                }
                if (init_host) {
                    response.config.init["init_host"] = init_host;
                }

                if (app_version) {
                    response.config[appid + ":kynetx_app_version"] = app_version;
                }
            }

        }
        console.log(sender.tab);

        sendResponse(response); // send back response
    }

    //load dispatch list
    function loadDispatch(completecallback) {
        domains = []; //clear it out
        var req = new XMLHttpRequest();
        if (init_host)
            req.open('GET', "http://" + init_host + "/js/dispatch/" + appid + "?cachebust=" + (new Date().getTime()), true);
        else
            req.open('GET', "http://init.kobj.net/js/dispatch/" + appid + "?cachebust=" + (new Date().getTime()), true);

        req.onreadystatechange = function (aEvt) {
            if (req.readyState == 4) {
                if (req.status == 200) {
                    var dispatchData = JSON.parse(req.responseText);
                    for (i in dispatchData[appid]) {
                        domain = dispatchData[appid][i];
                        //alert(domain);
                        domains.push(domain);
                    }
                    if (completecallback) completecallback();
                    console.log(req.responseText);
                } else {
                    //alert("Error loading page\n");
                }
            }

        };
        req.send();
    }//end loadDispatch


    function sync_request(url, method) {

        var data = null;
        // method = "POST";
        if (method == "POST") {
            var result = split_post_data(url);
            url = result.url;
            data = result.data;
        }
        var req = new XMLHttpRequest();
        req.open(method, url, false);
        if (method == "POST") {
            req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        }
        req.send(data);
        return req.responseText;
    }
    full_runtime = sync_request(kynetx_runtime_url, "GET");
    loadDispatch();


</script>

<body>
My Background Page.
</body>
</html>