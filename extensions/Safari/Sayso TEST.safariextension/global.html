<!DOCTYPE html>
<html>
<head>
  <title></title>
  <script type="text/javascript" charset="utf-8">

appid = "a239x22";
domains = [];
var response = null;
var kynetx_runtime_url = "http://init.kobj.net/js/shared/kobj-static.js";
callback_host = "log.kobj.net";
init_host = "init.kobj.net";
eval_host = "cs.kobj.net";
var app_version = "prod";

var full_runtime;


function respondToMessage(event) {

     var message = event.message;

    var response = {plantTags:false};
    var plantTags = false;
    if (message.hostname) {
        for (i in domains) {
            var Kdomain = new RegExp(domains[i]);
            if (message.hostname.search(Kdomain) > -1) {
                plantTags = true;
                break;
            }
        }
    }

    if (plantTags) {
        response = {
            plantTags:true,
            full_runtime: full_runtime,
            config: {
                rids: [appid],
                endpoint: {
                    name: 'KBXch',
                    version: '0.1',
                    type: 'js'
                }
            }
        };

        // Check for magic dev options
        if (init_host || callback_host || eval_host) {
            response.config["init"] = {};
        }
        if (callback_host) {
            response.config.init["callback_host"] = callback_host;
        }
        if (eval_host) {
            response.config.init["eval_host"] = eval_host;
        }
        if (init_host) {
            response.config.init["init_host"] = init_host;
        }

        if (app_version) {
            response.config[appid + ":kynetx_app_version"] = app_version;
        }
    }


    event.target.page.dispatchMessage("loadruntime", response);

}


function loadDispatch(completecallback) {
    domains = []; //clear it out
    var req = new XMLHttpRequest();
    req.open('GET', "http://" + init_host + "/js/dispatch/" + appid + "?cachebust=" + (new Date().getTime()), true);

    req.onreadystatechange = function (aEvt) {
        if (req.readyState == 4) {
            if (req.status == 200) {
                var dispatchData = JSON.parse(req.responseText);
                for (i in dispatchData[appid]) {
                    domain = dispatchData[appid][i];
                    // alert(domain);
                    domains.push(domain);
                }
            }
        }

    };
    req.send();
}

function sync_request(url, method) {

    url = url + "?tm=" + new Date().valueOf();
    var req = new XMLHttpRequest();
    req.open(method, url, false);
    req.send();
    return req.responseText;

}
full_runtime = sync_request(kynetx_runtime_url, "GET");
loadDispatch();


safari.application.addEventListener("message", respondToMessage, false);

  </script>
</head>
<body>
</body>
</html>
